install:ci:
  summary: install the necessary dependencies to run in CI. does not run `install`
  command: |-
    go get \
        golang.org/x/tools/cmd/cover \
        github.com/mattn/goveralls \
        github.com/tcnksm/ghr \
        github.com/mitchellh/gox

install:
  summary: install the dependencies to develop locally
  command: go get -v {{ .files }}

tests:
  summary: run the tests
  command: go test {{ .files }}

test:coverage:
  summary: run the tests, generate a coverage report, and report it to coveralls
  command: |-
    go test -v -covermode=atomic -coverprofile=coverage.out {{ .files }} &&
    $HOME/gopath/bin/goveralls -coverprofile=coverage.out -service=travis-ci -repotoken $COVERALLS_TOKEN

build:
  summary: build executable in all supported architectures
  command: |-
    gox -os="linux darwin windows" -arch="amd64" -output="bin/gateway_{{"{{"}}.OS}}_{{"{{"}}.Arch}}" -verbose ./cmd/...

deploy:
  summary: push the built artifacts to the release. assumes its running in CI
  command: |-
    ghr -t $GITHUB_TOKEN  -u "nautilus" -r "gateway" -delete $TRAVIS_TAG ./bin

variables:
  files: '$(go list -v ./... | grep -iEv "cmd|examples")'
